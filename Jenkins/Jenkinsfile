pipeline{
    agent any
    stages{
        
        stage("Git Checkout"){
            steps{

                git branch: 'main', url: 'https://github.com/vickydevo/springboot.git'
            }
         
        }
               stage ("gitleaks"){
            steps {
              
                sh "gitleaks detect --source . --report-path=report.json --report-format=json"



            }
        }
        stage("SonarQube SAST Scan"){
            steps{
                
                sh " mvn clean verify sonar:sonar -Dsonar.projectKey=Java-spring -Dsonar.host.url=http://100.3.125.217:9000 -Dsonar.token=sqa_26dbfe11088a39d6062911bb6a08da8828498"
            }
         
        }
        stage("OWASP Dependency Check Scan"){
            steps{
             sh "mvn dependency-check:check -DautoUpdate=false -DdataDirectory=/var/lib/jenkins/dependency-check-data/12.0"
             // sh "mvn dependency-check:check -DautoUpdate=false -DdataDirectory=/home/ubuntu/.m2/repository/org/owasp/dependency-check-data/"
            }
            post {
        always {
            // This step is provided by the Jenkins Plugin to display the UI report
            // It looks for the XML file in the 'target' folder by default
            dependencyCheckPublisher pattern: 'target/dependency-check-report.html'
        }
    }
         
        }
        stage("Docker Build"){
            steps{
                sh "docker build -t springboot:v1 . "
                sh "docker images"
            }
         
        }
       stage("Trivy Image Scan") {
            steps {
                // Run the scan and output to a text file
                // --exit-code 0 ensures the build continues even if vulnerabilities are found
                // Use --exit-code 1 if you want the pipeline to fail on HIGH/CRITICAL
                // sh "trivy image --severity HIGH,CRITICAL --format table --output report.txt springboot:v1"
                sh "trivy image --severity HIGH,CRITICAL --format template --template '@/usr/local/share/trivy/templates/html.tpl' --output report.html springboot:v1"
            }
            post {
                always {
                    // This makes the report available in the Jenkins Build UI
                    // archiveArtifacts artifacts: 'report.txt', fingerprint: true
                    archiveArtifacts artifacts: 'report.html', fingerprint: true
                }
            }
        }
    }
}
// ############################################################
// Enhanced Jenkinsfile with SonarQube, OWASP Dependency Check, and Trivy Integration
// ############################################################

pipeline {
    agent any
    
    tools {
        // Ensure these names match what you configured in Jenkins 'Global Tool Configuration'
        maven 'Maven3'
        jdk 'Java21'
    }

    stages {
        stage('Git Checkout') {
            steps {
                git 'https://github.com/your-repo/springboot-app.git'
            }
        }

        // --- STAGE 1: SONARQUBE (SAST) ---
        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('SonarQubeServer') { // 'SonarQubeServer' is the name in Jenkins System Config
                    sh "mvn clean verify sonar:sonar"
                }
            }
        }
        
        stage("Quality Gate") {
            steps {
                // This waits for SonarQube to finish and fails the build if the Gate fails
                waitForQualityGate abortPipeline: true
            }
        }

        // --- STAGE 2: OWASP DEPENDENCY CHECK (SCA) ---
        stage('OWASP Dependency Check') {
            steps {
                // This runs the scan on your project libraries
                dependencyCheck additionalArguments: '--scan ./ --format HTML --format XML', odcInstallation: 'DP-Check'
                
                // This publishes the results as a graph in Jenkins
                dependencyCheckPublisher pattern: 'target/dependency-check-report.xml'
            }
        }

        stage('Build & Dockerize') {
            steps {
                sh "mvn package -DskipTests"
                sh "docker build -t springboot:v1 ."
            }
        }

        // --- STAGE 3: TRIVY (Image Scan) ---
        stage('Trivy Image Scan') {
            steps {
                // Generate a table report for the console and a text file for artifacts
                sh "trivy image --severity HIGH,CRITICAL --format table --output report.txt springboot:v1"
            }
            post {
                always {
                    archiveArtifacts artifacts: 'report.txt', fingerprint: true
                }
            }
        }
    }
}